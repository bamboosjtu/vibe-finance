openapi: 3.0.3
info:
  title: Personal Investment Management API
  version: 0.2.0
  description: MVP API for personal investment management tool (snapshot-authoritative).
servers:
- url: '{{baseUrl}}'
  description: Variable base URL
components:
  schemas:
    Institution:
      type: object
      properties:
        id:
          type: integer
        name:
          type: string
      required:
      - id
      - name
    Account:
      type: object
      properties:
        id:
          type: integer
        name:
          type: string
        institution_id:
          type: integer
          nullable: true
        type:
          type: string
          enum:
          - cash
          - debit
          - credit
          - investment_cash
          - other
        currency:
          type: string
          default: CNY
        is_liquid:
          type: boolean
      required:
      - id
      - name
      - type
      - currency
      - is_liquid
    SnapshotItem:
      type: object
      properties:
        date:
          type: string
          format: date
        account_id:
          type: integer
        balance:
          type: number
      required:
      - date
      - account_id
      - balance
    Product:
      type: object
      properties:
        id:
          type: integer
        name:
          type: string
        institution_id:
          type: integer
          nullable: true
        product_code:
          type: string
          nullable: true
        product_type:
          type: string
          enum:
          - bank_wmp
          - money_market
          - term_deposit
          - fund
          - stock
          - other
        risk_level:
          type: string
          nullable: true
          description: External label, e.g. R1-R5
        term_days:
          type: integer
          nullable: true
        liquidity_rule:
          type: string
          enum:
          - open
          - closed
          - periodic_open
        settle_days:
          type: integer
        note:
          type: string
          nullable: true
        valuation_mode:
          type: string
          enum:
          - product_value
          default: product_value
      required:
      - id
      - name
      - product_type
      - liquidity_rule
      - settle_days
      - valuation_mode
    ValuationPoint:
      type: object
      properties:
        product_id:
          type: integer
        date:
          type: string
          format: date
        market_value:
          type: number
      required:
      - product_id
      - date
      - market_value
    Transaction:
      type: object
      properties:
        id:
          type: integer
        product_id:
          type: integer
        account_id:
          type: integer
        category:
          type: string
          enum:
          - buy
          - redeem_request
          - redeem_settle
          - fee
        trade_date:
          type: string
          format: date
        settle_date:
          type: string
          format: date
          nullable: true
        amount:
          type: number
          description: '买入为正，卖出为负'
        note:
          type: string
          nullable: true
      required:
      - id
      - product_id
      - account_id
      - category
      - trade_date
      - amount
    Warning:
      type: object
      properties:
        date:
          type: string
          format: date
        account_id:
          type: integer
        snapshot_balance:
          type: number
        derived_balance:
          type: number
        diff:
          type: number
        severity:
          type: string
          enum:
          - warning
        hint:
          type: string
      required:
      - date
      - account_id
      - snapshot_balance
      - derived_balance
      - diff
      - severity
      - hint
    DashboardSummary:
      type: object
      properties:
        date:
          type: string
          format: date
          description: 快照日期
        total_assets:
          type: number
          description: 总资产 = 所有账户 balance 之和
        liquid_assets:
          type: number
          description: 流动资产 = is_liquid=true 的账户 balance 之和
        liabilities:
          type: number
          description: 负债 = type=credit 的账户 balance 之和（负数）
        available_cash:
          type: number
          description: 基础可用现金 = liquid_assets + liabilities（流动资产扣除信用卡欠款后的净流动资产）
        real_available_cash:
          type: number
          description: Sprint 4 - 实际可用现金 = available_cash - pending_redeems（扣除在途赎回后的真实可动用现金）
        pending_redeems:
          type: number
          description: Sprint 4 - 在途赎回金额（已发起赎回但尚未到账的资金）
        future_7d:
          type: number
          description: Sprint 4 - 未来7天预计到账金额（基于T+N规则推算）
        future_30d:
          type: number
          description: Sprint 4 - 未来30天预计到账金额（基于T+N规则推算）
        future_90d:
          type: number
          description: Sprint 5 - 未来90天预计到账金额（基于T+N规则推算）
        by_type:
          type: object
          description: 按账户类型分组的余额
          properties:
            cash:
              type: number
            debit:
              type: number
            credit:
              type: number
            investment_cash:
              type: number
            other:
              type: number
      required:
      - date
      - total_assets
      - liquid_assets
      - liabilities
      - available_cash
      - real_available_cash
      - pending_redeems
      - future_7d
      - future_30d
      - future_90d
      - by_type
    ProductMetrics:
      type: object
      nullable: true
      properties:
        twr:
          type: number
          description: Time-Weighted Return (百分比，如 5.5 表示 5.5%)
        annualized:
          type: number
          description: Annualized return (百分比，如 8.2 表示 8.2%)
        volatility:
          type: number
          description: Annualized volatility (百分比，如 12.5 表示 12.5%)
        max_drawdown:
          type: number
          description: Maximum drawdown (百分比，如 -15.3 表示 -15.3%)
        drawdown_recovery_days:
          type: integer
          description: Days to recover from max drawdown
    ChartPoint:
      type: object
      properties:
        date:
          type: string
          format: date
        market_value:
          type: number
        source:
          type: string
          enum:
          - manual
          - interpolated
          - extrapolated
          description: |
            估值点来源类型：
            - manual: 用户录入的真实估值点
            - interpolated: 在两个 manual 点之间线性插值
            - extrapolated: 在最后一个 manual 点之后外推（保持最后一个值）
      required:
      - date
      - market_value
      - source
  parameters:
    FromDate:
      name: from
      in: query
      schema:
        type: string
        format: date
      required: true
    ToDate:
      name: to
      in: query
      schema:
        type: string
        format: date
      required: true
    Date:
      name: date
      in: query
      schema:
        type: string
        format: date
      required: true
paths:
  /api/institutions:
    get:
      summary: List institutions
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  code:
                    type: integer
                  data:
                    type: object
                    properties:
                      items:
                        type: array
                        items:
                          $ref: '#/components/schemas/Institution'
                    required:
                    - items
                  message:
                    type: string
                required:
                - code
                - data
                - message
    post:
      summary: Create institution
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  code:
                    type: integer
                  data:
                    $ref: '#/components/schemas/Institution'
                  message:
                    type: string
                required:
                - code
                - data
                - message
              example:
                code: 200
                data:
                  id: 1
                  name: 长沙银行
                message: ok
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
              required:
              - name
            example:
              name: 长沙银行
  /api/dashboard/pending_redeems:
    get:
      summary: Sprint 4 - 获取在途赎回资金明细
      parameters:
      - name: product_id
        in: query
        required: false
        schema:
          type: integer
        description: 可选，指定产品ID查询特定产品的在途赎回
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  code:
                    type: integer
                  data:
                    type: object
                    properties:
                      total_pending:
                        type: number
                        description: 在途赎回总额
                      items:
                        type: array
                        items:
                          type: object
                          properties:
                            product_id:
                              type: integer
                            product_name:
                              type: string
                            pending_amount:
                              type: number
                            latest_request_date:
                              type: string
                              format: date
                              nullable: true
                            estimated_settle_date:
                              type: string
                              format: date
                              nullable: true
                  message:
                    type: string
                required:
                - code
                - data
                - message
  /api/dashboard/future_cash_flow:
    get:
      summary: Sprint 4 - 获取未来现金流预测
      parameters:
      - name: days
        in: query
        required: false
        schema:
          type: integer
          default: 30
        description: 预测天数，默认30天
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  code:
                    type: integer
                  data:
                    type: object
                    properties:
                      items:
                        type: array
                        items:
                          type: object
                          properties:
                            date:
                              type: string
                              format: date
                            amount:
                              type: number
                            source:
                              type: string
                              enum: [redeem, maturity]
                            description:
                              type: string
                            product_id:
                              type: integer
                            note:
                              type: string
                              description: 规则推算备注（如"规则推算，仅供参考"）
                              nullable: true
                      total_7d:
                        type: number
                        description: 未来7天预计到账总额
                      total_30d:
                        type: number
                        description: 未来30天预计到账总额
                      by_date:
                        type: object
                        description: 按日期分组的现金流
                        additionalProperties:
                          type: array
                          items:
                            type: object
                            properties:
                              date:
                                type: string
                                format: date
                              amount:
                                type: number
                              source:
                                type: string
                                enum: [redeem, maturity]
                              description:
                                type: string
                              product_id:
                                type: integer
                              note:
                                type: string
                                description: 规则推算备注
                                nullable: true
                  message:
                    type: string
                required:
                - code
                - data
                - message
  /api/dashboard/cash_detail:
    get:
      summary: Sprint 4 - 获取现金详情（包含账户明细和在途明细）
      parameters:
      - name: date
        in: query
        required: false
        schema:
          type: string
          format: date
        description: 目标日期，默认为最新快照日期
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  code:
                    type: integer
                  data:
                    type: object
                    properties:
                      date:
                        type: string
                        format: date
                      base_available:
                        type: number
                        description: 基础可用现金
                      pending_redeems:
                        type: number
                        description: 在途赎回金额
                      real_available:
                        type: number
                        description: 实际可用现金
                      details:
                        type: object
                        properties:
                          liquid_accounts:
                            type: array
                            items:
                              type: object
                              properties:
                                account_id:
                                  type: integer
                                account_name:
                                  type: string
                                account_type:
                                  type: string
                                balance:
                                  type: number
                          pending_details:
                            type: array
                            items:
                              type: object
                  message:
                    type: string
                required:
                - code
                - data
                - message
  /api/dashboard/cash_timeline:
    get:
      summary: Sprint 5 - 获取资金时间轴视图
      description: |
        展示从当前时间点开始的资金流动性变化：
        - 当前：可用现金、在途赎回、锁定资金
        - 未来里程碑：+7d、+30d、+90d 的预计可用现金
      parameters:
      - name: milestones
        in: query
        required: false
        schema:
          type: string
          default: "7,30,90"
        description: 里程碑天数，逗号分隔，默认 "7,30,90"
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  code:
                    type: integer
                  data:
                    type: object
                    properties:
                      current:
                        type: object
                        properties:
                          date:
                            type: string
                            format: date
                          available_cash:
                            type: number
                            description: 当前可用现金
                          pending_redeems:
                            type: number
                            description: 在途赎回金额
                          locked_in_products:
                            type: number
                            description: 锁定在产品中的资金
                      milestones:
                        type: array
                        items:
                          type: object
                          properties:
                            date:
                              type: string
                              format: date
                            label:
                              type: string
                              description: 里程碑标签，如 "+7天"
                            days_from_now:
                              type: integer
                            projected_available_cash:
                              type: number
                              description: 预计可用现金
                            accumulated_inflow:
                              type: number
                              description: 累计预计到账
                            changes:
                              type: array
                              items:
                                type: object
                                properties:
                                  date:
                                    type: string
                                    format: date
                                  amount:
                                    type: number
                                  source:
                                    type: string
                                    enum: [redeem, maturity]
                                  description:
                                    type: string
                                  product_id:
                                    type: integer
                                  note:
                                    type: string
                  message:
                    type: string
                required:
                - code
                - data
                - message
  /api/products/{product_id}/pending_redeem:
    get:
      summary: Sprint 4 - 获取单个产品的在途赎回信息
      parameters:
      - name: product_id
        in: path
        required: true
        schema:
          type: integer
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  code:
                    type: integer
                  data:
                    type: object
                    properties:
                      product_id:
                        type: integer
                      product_name:
                        type: string
                      pending_amount:
                        type: number
                      latest_request_date:
                        type: string
                        format: date
                        nullable: true
                      estimated_settle_date:
                        type: string
                        format: date
                        nullable: true
                      settle_days:
                        type: integer
                        description: 产品赎回到账天数(T+N)
                  message:
                    type: string
                required:
                - code
                - data
                - message
              example:
                code: 200
                data:
                  product_id: 1
                  product_name: 测试产品
                  pending_amount: 50000
                  latest_request_date: '2024-01-15'
                  estimated_settle_date: '2024-01-17'
                  settle_days: 2
                message: ok
  /api/products/{product_id}/liquidity_status:
    get:
      summary: Sprint 5 - 获取产品流动性状态
      description: |
        展示产品的时间维度流动性信息：
        - 是否处于锁定期
        - 锁定期结束日
        - 最近可变现日期
      parameters:
      - name: product_id
        in: path
        required: true
        schema:
          type: integer
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  code:
                    type: integer
                  data:
                    type: object
                    properties:
                      product_id:
                        type: integer
                      product_name:
                        type: string
                      is_locked:
                        type: boolean
                        description: 是否处于锁定期
                      lock_end_date:
                        type: string
                        format: date
                        nullable: true
                        description: 锁定期结束日
                      next_liquid_date:
                        type: string
                        format: date
                        nullable: true
                        description: 最近可变现日期
                      liquidity_type:
                        type: string
                        enum: [open, closed, periodic_open]
                      term_days:
                        type: integer
                      settle_days:
                        type: integer
                      note:
                        type: string
                        description: 提示说明
                  message:
                    type: string
                required:
                - code
                - data
                - message
              example:
                code: 200
                data:
                  product_id: 1
                  product_name: 某某定期理财
                  is_locked: true
                  lock_end_date: '2024-04-15'
                  next_liquid_date: '2024-04-15'
                  liquidity_type: closed
                  term_days: 90
                  settle_days: 1
                  note: 封闭式产品，预计 2024-04-15 后可变现
                message: ok
  /api/reconciliation/warnings:
    get:
      summary: Sprint 6 - 获取所有对账警告（聚合接口）
      parameters:
      - name: date
        in: query
        required: false
        schema:
          type: string
          format: date
        description: 检查日期，默认今天
      - name: account_threshold
        in: query
        required: false
        schema:
          type: number
          default: 1.0
        description: 账户差异阈值
      - name: gap_days
        in: query
        required: false
        schema:
          type: integer
          default: 14
        description: 估值断档阈值天数
      - name: redeem_buffer
        in: query
        required: false
        schema:
          type: integer
          default: 3
        description: 赎回缓冲天数
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  code:
                    type: integer
                  data:
                    type: object
                    properties:
                      items:
                        type: array
                        items:
                          type: object
                          properties:
                            id:
                              type: string
                            level:
                              type: string
                              enum: [warn, info]
                            type:
                              type: string
                              enum: [account_diff, redeem_anomaly, valuation_gap]
                            title:
                              type: string
                            description:
                              type: string
                            object_type:
                              type: string
                              enum: [account, product]
                            object_id:
                              type: integer
                            object_name:
                              type: string
                            date:
                              type: string
                              format: date
                              nullable: true
                            diff_value:
                              type: number
                              nullable: true
                            suggested_action:
                              type: string
                            link_to:
                              type: string
                            status:
                              type: string
                              enum: [open, acknowledged, muted]
                              description: Sprint 6 (S6-5) 警告状态
                            mute_reason:
                              type: string
                              nullable: true
                              description: Sprint 6 (S6-5) 静音原因
                      summary:
                        type: object
                        properties:
                          total:
                            type: integer
                          warn:
                            type: integer
                          info:
                            type: integer
                  message:
                    type: string
  /api/reconciliation/account_diffs:
    get:
      summary: Sprint 6 - 获取账户对账差异
      parameters:
      - name: date
        in: query
        required: false
        schema:
          type: string
          format: date
      - name: threshold
        in: query
        required: false
        schema:
          type: number
          default: 1.0
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  code:
                    type: integer
                  data:
                    type: object
                    properties:
                      items:
                        type: array
                        items:
                          type: object
                          properties:
                            account_id:
                              type: integer
                            account_name:
                              type: string
                            check_date:
                              type: string
                              format: date
                            snapshot_balance:
                              type: number
                            derived_balance:
                              type: number
                            diff:
                              type: number
                            severity:
                              type: string
                              enum: [info, warn]
                            hint:
                              type: string
                  message:
                    type: string
  /api/reconciliation/redeem_check:
    get:
      summary: Sprint 6 - 获取赎回在途一致性检查
      parameters:
      - name: buffer_days
        in: query
        required: false
        schema:
          type: integer
          default: 3
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  code:
                    type: integer
                  data:
                    type: object
                    properties:
                      items:
                        type: array
                        items:
                          type: object
                          properties:
                            product_id:
                              type: integer
                            product_name:
                              type: string
                            pending_amount:
                              type: number
                            status:
                              type: string
                              enum: [normal, negative, overdue]
                            latest_request_date:
                              type: string
                              format: date
                              nullable: true
                            expected_settle_date:
                              type: string
                              format: date
                              nullable: true
                            days_pending:
                              type: integer
                              nullable: true
                            hint:
                              type: string
                  message:
                    type: string
  /api/reconciliation/valuation_gaps:
    get:
      summary: Sprint 6 - 获取估值断档产品列表
      parameters:
      - name: gap_days
        in: query
        required: false
        schema:
          type: integer
          default: 14
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  code:
                    type: integer
                  data:
                    type: object
                    properties:
                      items:
                        type: array
                        items:
                          type: object
                          properties:
                            product_id:
                              type: integer
                            product_name:
                              type: string
                            last_valuation_date:
                              type: string
                              format: date
                              nullable: true
                            days_since:
                              type: integer
                            has_recent_trade:
                              type: boolean
                            severity:
                              type: string
                              enum: [info, warn]
                            hint:
                              type: string
                            last_trade_date:
                              type: string
                              format: date
                              nullable: true
                              description: Sprint 6 可选：最近一次交易日期
                            days_since_trade:
                              type: integer
                              nullable: true
                              description: Sprint 6 可选：距离上次交易的天数
                  message:
                    type: string
  /api/reconciliation/warnings/{warning_id}/status:
    put:
      summary: Sprint 6 (S6-5) - 更新警告状态
      parameters:
      - name: warning_id
        in: path
        required: true
        schema:
          type: string
        description: 警告唯一标识
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                status:
                  type: string
                  enum: [open, acknowledged, muted]
                  description: 新状态
                mute_reason:
                  type: string
                  nullable: true
                  description: 静音原因（当 status=muted 时可选）
              required:
              - status
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  code:
                    type: integer
                  data:
                    type: object
                    properties:
                      id:
                        type: integer
                      warning_id:
                        type: string
                      status:
                        type: string
                        enum: [open, acknowledged, muted]
                      mute_reason:
                        type: string
                        nullable: true
                      updated_at:
                        type: string
                        format: date-time
                  message:
                    type: string
  /api/reconciliation/warnings/{warning_id}/restore:
    post:
      summary: Sprint 6 (S6-5) - 将警告恢复为 open 状态
      parameters:
      - name: warning_id
        in: path
        required: true
        schema:
          type: string
        description: 警告唯一标识
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  code:
                    type: integer
                  data:
                    type: object
                    properties:
                      id:
                        type: integer
                      warning_id:
                        type: string
                      status:
                        type: string
                        enum: [open, acknowledged, muted]
                      updated_at:
                        type: string
                        format: date-time
                  message:
                    type: string
        '404':
          description: Warning not found
          content:
            application/json:
              schema:
                type: object
                properties:
                  code:
                    type: integer
                  message:
                    type: string
  /api/accounts:
    get:
      summary: List accounts
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  code:
                    type: integer
                  data:
                    type: object
                    properties:
                      items:
                        type: array
                        items:
                          $ref: '#/components/schemas/Account'
                    required:
                    - items
                  message:
                    type: string
                required:
                - code
                - data
                - message
              example:
                code: 200
                data:
                  items:
                  - id: 10
                    name: 长沙银行-借记卡
                    institution_id: 1
                    type: debit
                    currency: CNY
                    is_liquid: true
                message: ok
    post:
      summary: Create account
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  code:
                    type: integer
                  data:
                    $ref: '#/components/schemas/Account'
                  message:
                    type: string
                required:
                - code
                - data
                - message
              example:
                code: 200
                data:
                  id: 11
                  name: 花呗
                  institution_id: 2
                  type: credit
                  currency: CNY
                  is_liquid: false
                message: ok
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                institution_id:
                  type: integer
                  nullable: true
                type:
                  type: string
                  enum:
                  - cash
                  - debit
                  - credit
                  - investment_cash
                  - other
                currency:
                  type: string
                  default: CNY
                is_liquid:
                  type: boolean
                  default: true
              required:
              - name
              - type
            example:
              name: 花呗
              institution_id: 2
              type: credit
              is_liquid: false
  /api/accounts/{id}:
    patch:
      summary: Update account
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  code:
                    type: integer
                  data:
                    $ref: '#/components/schemas/Account'
                  message:
                    type: string
                required:
                - code
                - data
                - message
              example:
                code: 200
                data:
                  id: 11
                  name: 花呗
                  institution_id: 2
                  type: credit
                  currency: CNY
                  is_liquid: true
                message: ok
      parameters:
      - name: id
        in: path
        required: true
        schema:
          type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                is_liquid:
                  type: boolean
                type:
                  type: string
                  enum:
                  - cash
                  - debit
                  - credit
                  - investment_cash
                  - other
                institution_id:
                  type: integer
                  nullable: true
                currency:
                  type: string
            example:
              is_liquid: true
    delete:
      summary: Delete account
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  code:
                    type: integer
                  data:
                    type: object
                    properties:
                      message:
                        type: string
                  message:
                    type: string
                required:
                - code
                - data
                - message
              example:
                code: 200
                data:
                  message: deleted
                message: ok
        '404':
          description: Not found
          content:
            application/json:
              schema:
                type: object
                properties:
                  code:
                    type: integer
                  message:
                    type: string
                required:
                - code
                - message
              example:
                code: 404
                message: Account 11 not found
      parameters:
      - name: id
        in: path
        required: true
        schema:
          type: integer
  /api/snapshots/batch_upsert:
    post:
      summary: Batch upsert snapshots (authoritative)
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  code:
                    type: integer
                  data:
                    type: object
                    properties:
                      inserted:
                        type: integer
                      updated:
                        type: integer
                      warnings:
                        type: array
                        items:
                          $ref: '#/components/schemas/Warning'
                    required:
                    - inserted
                    - updated
                    - warnings
                  message:
                    type: string
                required:
                - code
                - data
                - message
              example:
                code: 200
                data:
                  inserted: 2
                  updated: 0
                  warnings: []
                message: ok
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                rows:
                  type: array
                  items:
                    $ref: '#/components/schemas/SnapshotItem'
              required:
              - rows
            example:
              rows:
              - date: '2025-01-05'
                account_id: 10
                balance: 6156.16
              - date: '2025-01-05'
                account_id: 11
                balance: -4048.06
  /api/snapshots:
    get:
      summary: Get snapshots by date
      parameters:
      - $ref: '#/components/parameters/Date'
      - name: fill
        in: query
        required: false
        schema:
          type: boolean
          default: false
        description: 是否使用最近日期的快照填充缺失数据
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  code:
                    type: integer
                  data:
                    type: object
                    properties:
                      date:
                        type: string
                        format: date
                      items:
                        type: array
                        items:
                          type: object
                          properties:
                            account_id:
                              type: integer
                            balance:
                              type: number
                            date:
                              type: string
                              format: date
                          required:
                          - account_id
                          - balance
                          - date
                    required:
                    - date
                    - items
                  message:
                    type: string
                required:
                - code
                - data
                - message
              example:
                code: 200
                data:
                  date: '2025-01-05'
                  items:
                  - account_id: 10
                    balance: 6156.16
                    date: '2025-01-05'
                  - account_id: 11
                    balance: -4048.06
                    date: '2025-01-05'
                message: ok
  /api/products:
    get:
      summary: List products with optional metrics
      parameters:
      - name: include_metrics
        in: query
        required: false
        schema:
          type: boolean
          default: false
        description: 是否包含各窗口期的收益指标
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  code:
                    type: integer
                  data:
                    type: object
                    properties:
                      items:
                        type: array
                        items:
                          allOf:
                          - $ref: '#/components/schemas/Product'
                          - type: object
                            properties:
                              total_principal:
                                type: number
                                description: 总持仓本金
                              total_shares:
                                type: number
                                description: 总持仓份额
                              latest_market_value:
                                type: number
                                description: 最新市值
                              metrics_by_window:
                                type: object
                                additionalProperties:
                                  $ref: '#/components/schemas/ProductMetrics'
                              metrics:
                                $ref: '#/components/schemas/ProductMetrics'
                  message:
                    type: string
                required:
                - code
                - data
                - message
    post:
      summary: Create product
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  code:
                    type: integer
                  data:
                    $ref: '#/components/schemas/Product'
                  message:
                    type: string
                required:
                - code
                - data
                - message
              example:
                code: 200
                data:
                  id: 201
                  name: 日日金
                  institution_id: 1
                  product_code: null
                  product_type: money_market
                  risk_level: R1
                  term_days: 0
                  liquidity_rule: open
                  settle_days: 0
                  note: 随时申赎
                  valuation_mode: product_value
                message: ok
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                institution_id:
                  type: integer
                  nullable: true
                product_code:
                  type: string
                  nullable: true
                product_type:
                  type: string
                  enum:
                  - bank_wmp
                  - money_market
                  - term_deposit
                  - fund
                  - stock
                  - other
                risk_level:
                  type: string
                  nullable: true
                term_days:
                  type: integer
                  nullable: true
                liquidity_rule:
                  type: string
                  enum:
                  - open
                  - closed
                  - periodic_open
                settle_days:
                  type: integer
                note:
                  type: string
                  nullable: true
                valuation_mode:
                  type: string
                  enum:
                  - product_value
                  default: product_value
              required:
              - name
              - product_type
              - liquidity_rule
            example:
              name: 日日金
              institution_id: 1
              product_type: money_market
              risk_level: R1
              term_days: 0
              liquidity_rule: open
              settle_days: 0
              note: 随时申赎
  /api/products/{id}:
    patch:
      summary: Update product
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  code:
                    type: integer
                  data:
                    $ref: '#/components/schemas/Product'
                  message:
                    type: string
                required:
                - code
                - data
                - message
              example:
                code: 200
                data:
                  id: 201
                  name: 日日金
                  institution_id: 1
                  product_code: null
                  product_type: money_market
                  risk_level: R1
                  term_days: 0
                  liquidity_rule: open
                  settle_days: 0
                  note: 随时申赎
                  valuation_mode: product_value
                message: ok
      parameters:
      - name: id
        in: path
        required: true
        schema:
          type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                institution_id:
                  type: integer
                  nullable: true
                product_code:
                  type: string
                  nullable: true
                product_type:
                  type: string
                  enum:
                  - bank_wmp
                  - money_market
                  - term_deposit
                  - fund
                  - stock
                  - other
                risk_level:
                  type: string
                  nullable: true
                term_days:
                  type: integer
                  nullable: true
                liquidity_rule:
                  type: string
                  enum:
                  - open
                  - closed
                  - periodic_open
                settle_days:
                  type: integer
                note:
                  type: string
                  nullable: true
                valuation_mode:
                  type: string
                  enum:
                  - product_value
            example:
              note: 更新备注
    delete:
      summary: Delete product
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  code:
                    type: integer
                  data:
                    type: object
                    properties:
                      message:
                        type: string
                  message:
                    type: string
                required:
                - code
                - data
                - message
              example:
                code: 200
                data:
                  message: deleted
                message: ok
        '404':
          description: Not found
          content:
            application/json:
              schema:
                type: object
                properties:
                  code:
                    type: integer
                  message:
                    type: string
                required:
                - code
                - message
              example:
                code: 404
                message: Product 201 not found
      parameters:
      - name: id
        in: path
        required: true
        schema:
          type: integer
  /api/products/{id}/chart:
    get:
      summary: Get product valuation chart data
      description: 获取产品市值走势，返回 manual 和 interpolated 点
      parameters:
      - name: id
        in: path
        required: true
        schema:
          type: integer
      - name: window
        in: query
        required: false
        schema:
          type: string
          enum:
          - 4w
          - 8w
          - 12w
          - 24w
          - 1y
          - ytd
          default: 8w
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  code:
                    type: integer
                  data:
                    type: object
                    properties:
                      product_id:
                        type: integer
                      valuation_mode:
                        type: string
                      points:
                        type: array
                        items:
                          $ref: '#/components/schemas/ChartPoint'
                  message:
                    type: string
                required:
                - code
                - data
                - message
  /api/products/{id}/metrics:
    get:
      summary: Get product metrics (TWR/annualized/volatility/drawdown)
      parameters:
      - name: id
        in: path
        required: true
        schema:
          type: integer
      - name: window
        in: query
        required: false
        schema:
          type: string
          enum:
          - 4w
          - 8w
          - 12w
          - 24w
          - 1y
          - ytd
          default: 8w
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  code:
                    type: integer
                  data:
                    type: object
                    properties:
                      product_id:
                        type: integer
                      valuation_mode:
                        type: string
                      window:
                        type: string
                      status:
                        type: string
                        enum:
                        - ok
                        - insufficient_data
                        - degraded
                      metrics:
                        $ref: '#/components/schemas/ProductMetrics'
                      reason:
                        type: string
                        nullable: true
                      degraded_reason:
                        type: string
                        nullable: true
                      degraded_fields:
                        type: array
                        items:
                          type: string
                  message:
                    type: string
                required:
                - code
                - data
                - message
              example:
                code: 200
                data:
                  product_id: 200
                  valuation_mode: product_value
                  window: 8w
                  status: ok
                  metrics:
                    twr: 0.0005946
                    annualized: 0.00388
                    volatility: 0.0012
                    max_drawdown: 0.0003
                    drawdown_recovery_days: 7
                message: ok
  /api/products/{id}/transactions:
    get:
      summary: Get product transactions
      parameters:
      - name: id
        in: path
        required: true
        schema:
          type: integer
      - name: from
        in: query
        required: false
        schema:
          type: string
          format: date
      - name: to
        in: query
        required: false
        schema:
          type: string
          format: date
      - name: window
        in: query
        required: false
        schema:
          type: string
          enum:
          - 4w
          - 8w
          - 12w
          - 24w
          - 1y
          - ytd
          default: 8w
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  code:
                    type: integer
                  data:
                    type: object
                    properties:
                      product_id:
                        type: integer
                      items:
                        type: array
                        items:
                          type: object
                          properties:
                            id:
                              type: integer
                            account_id:
                              type: integer
                            category:
                              type: string
                              enum:
                              - buy
                              - redeem_request
                              - redeem_settle
                              - fee
                            trade_date:
                              type: string
                              format: date
                            settle_date:
                              type: string
                              format: date
                              nullable: true
                            amount:
                              type: number
                            note:
                              type: string
                              nullable: true
                  message:
                    type: string
                required:
                - code
                - data
                - message
  /api/valuations/batch_upsert:
    post:
      summary: Batch upsert product valuations
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  code:
                    type: integer
                  data:
                    type: object
                    properties:
                      inserted:
                        type: integer
                      updated:
                        type: integer
                      warnings:
                        type: array
                        items:
                          type: string
                    required:
                    - inserted
                    - updated
                    - warnings
                  message:
                    type: string
                required:
                - code
                - data
                - message
              example:
                code: 200
                data:
                  inserted: 2
                  updated: 0
                  warnings: []
                message: ok
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                rows:
                  type: array
                  items:
                    $ref: '#/components/schemas/ValuationPoint'
                source:
                  type: string
                  default: manual
              required:
              - rows
            example:
              rows:
              - product_id: 200
                date: '2025-01-05'
                market_value: 100059.46
              - product_id: 201
                date: '2025-01-05'
                market_value: 67747.76
  /api/products/{id}/valuations:
    get:
      summary: Get product valuations in range
      parameters:
      - name: id
        in: path
        required: true
        schema:
          type: integer
      - $ref: '#/components/parameters/FromDate'
      - $ref: '#/components/parameters/ToDate'
      - name: page
        in: query
        required: false
        schema:
          type: integer
          default: 1
      - name: page_size
        in: query
        required: false
        schema:
          type: integer
          default: 20
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  code:
                    type: integer
                  data:
                    type: object
                    properties:
                      product_id:
                        type: integer
                      points:
                        type: array
                        items:
                          type: object
                          properties:
                            date:
                              type: string
                              format: date
                            market_value:
                              type: number
                      pagination:
                        type: object
                        properties:
                          page:
                            type: integer
                          page_size:
                            type: integer
                          total:
                            type: integer
                          total_pages:
                            type: integer
                  message:
                    type: string
                required:
                - code
                - data
                - message
    delete:
      summary: Delete product valuation
      parameters:
      - name: id
        in: path
        required: true
        schema:
          type: integer
      - name: date
        in: query
        required: true
        schema:
          type: string
          format: date
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  code:
                    type: integer
                  data:
                    type: object
                    properties:
                      message:
                        type: string
                  message:
                    type: string
                required:
                - code
                - data
                - message
        '404':
          description: Not found
          content:
            application/json:
              schema:
                type: object
                properties:
                  code:
                    type: integer
                  message:
                    type: string
                required:
                - code
                - message
  /api/transactions:
    post:
      summary: Create transaction
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  code:
                    type: integer
                  data:
                    $ref: '#/components/schemas/Transaction'
                  message:
                    type: string
                required:
                - code
                - data
                - message
              example:
                code: 200
                data:
                  id: 50001
                  product_id: 200
                  account_id: 10
                  category: buy
                  trade_date: '2025-01-05'
                  settle_date: null
                  amount: 100000
                  note: 申购28D
                message: ok
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                product_id:
                  type: integer
                account_id:
                  type: integer
                category:
                  type: string
                  enum:
                  - buy
                  - redeem_request
                  - redeem_settle
                  - fee
                trade_date:
                  type: string
                  format: date
                settle_date:
                  type: string
                  format: date
                  nullable: true
                amount:
                  type: number
                  description: '买入为正，卖出为负'
                note:
                  type: string
                  nullable: true
              required:
              - product_id
              - account_id
              - category
              - trade_date
              - amount
            example:
              product_id: 200
              account_id: 10
              category: buy
              trade_date: '2025-01-05'
              amount: 100000
              note: 申购28D
    get:
      summary: List transactions with filters
      parameters:
      - name: product_id
        in: query
        required: false
        schema:
          type: integer
      - name: account_id
        in: query
        required: false
        schema:
          type: integer
      - name: category
        in: query
        required: false
        schema:
          type: string
      - name: from
        in: query
        required: false
        schema:
          type: string
          format: date
      - name: to
        in: query
        required: false
        schema:
          type: string
          format: date
      - name: page
        in: query
        required: false
        schema:
          type: integer
          default: 1
      - name: page_size
        in: query
        required: false
        schema:
          type: integer
          default: 20
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  code:
                    type: integer
                  data:
                    type: object
                    properties:
                      items:
                        type: array
                        items:
                          $ref: '#/components/schemas/Transaction'
                      pagination:
                        type: object
                        properties:
                          page:
                            type: integer
                          page_size:
                            type: integer
                          total:
                            type: integer
                          total_pages:
                            type: integer
                  message:
                    type: string
                required:
                - code
                - data
                - message
  /api/transactions/{id}:
    delete:
      summary: Delete transaction
      parameters:
      - name: id
        in: path
        required: true
        schema:
          type: integer
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  code:
                    type: integer
                  data:
                    type: object
                    properties:
                      message:
                        type: string
                  message:
                    type: string
                required:
                - code
                - data
                - message
        '404':
          description: Not found
          content:
            application/json:
              schema:
                type: object
                properties:
                  code:
                    type: integer
                  message:
                    type: string
                required:
                - code
                - message
  /api/dashboard/available_dates:
    get:
      summary: Get all available snapshot dates
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  code:
                    type: integer
                  data:
                    type: object
                    properties:
                      dates:
                        type: array
                        items:
                          type: string
                          format: date
                  message:
                    type: string
                required:
                - code
                - data
                - message
  /api/dashboard/latest_date:
    get:
      summary: Get latest snapshot date
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  code:
                    type: integer
                  data:
                    type: object
                    properties:
                      date:
                        type: string
                        format: date
                        nullable: true
                  message:
                    type: string
                required:
                - code
                - data
                - message
  /api/dashboard/summary:
    get:
      summary: Get dashboard summary for a date
      parameters:
      - name: date
        in: query
        required: true
        schema:
          type: string
          format: date
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  code:
                    type: integer
                  data:
                    $ref: '#/components/schemas/DashboardSummary'
                  message:
                    type: string
                required:
                - code
                - data
                - message
