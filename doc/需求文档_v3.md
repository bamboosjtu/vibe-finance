# 个人投资管理工具（需求文档 v3 · 参考收益版）

> 本版本在 v2 基础上继续**收敛现实使用路径**：  
> 本阶段不维护 Lot / InternalHolding（不建表、不生成、不分配）；未来如需精细分析，可基于 Transaction 回放重建。
> 产品详情页融合：估值 + 买入/卖出（现金流）
> 收益率采用“参考档”（允许近似，但明确降级与提示）
> 核心原则不变：**可实现、口径清晰、避免误导**。

---

## 0. 数据分层与权威性（必须读）

### 0.1 四类数据的权威性

1. **Snapshot（资产快照）= 账面事实（最高权威）**  
   你在某天看到的账户余额就是事实；系统不会“纠正”它。

2. **Valuation Point（估值点）= 观察事实（允许缺失/不连续）**  
   你间断录入的“某日当前市值金额”，可缺失、可不连续。

3. **Derived Series（推导序列）= 计算用（不回写事实表）**  
   插值、聚合、收益近似计算只用于分析展示，不回写事实表。

4. **Metrics（指标）= 分级展示**
   - 严格口径不成立 → 降级或灰显
   - 参考口径 → 明确标注“近似/参考”

### 0.2 对账原则（提示型，不阻断）

- **Snapshot 是权威**：  
  若 Snapshot 与现金流推导余额不一致，仅提示 warning，不修正 Snapshot。

---

## 一、项目背景

目标：将个人投资管理从“记录余额”升级为“辅助判断资金效率”。

现实约束：

- 多数理财产品 **只提供某日当前市值**
- 买入、卖出、到账存在时间差
- 数据不完整是常态，而非异常

因此：

> 本系统的收益分析目标是 **“辅助判断”而非“精确审计”**。

---

## 二、核心设计思想（本版关键变化）

### 2.1 用户视角：以“产品”为唯一操作对象

用户的所有操作都发生在 **产品详情页**：

- 录入买入金额
- 录入卖出/赎回金额
- 间断录入产品估值点
- 查看走势与收益参考

用户不需要理解：

- 批次（Lot）
- 资金分配规则
- 严格财务收益模型

---

## 三、记录功能（P0）

### 3.1 资产与账户管理

对象：银行账户、信用卡等

功能：

- 账户列表（活期 / 借记 / 信用卡 / 投资账户）
- Snapshot 录入与历史
- 基础流水查看

关键点：

- 账户是现金的承载体
- Snapshot 是最高权威事实

---

### 3.2 投资产品管理

对象：银行理财、基金、股票等

产品字段：

- 产品名 / 所属机构
- 风险等级（R1–R5，外部标签）
- 产品结构（封闭 / 定开 / 开放）
- 赎回规则（是否可赎回、T+N）
- 备注

---

### 3.3 产品详情页内的统一记录

> **估值与交易在同一页面完成（UI 融合，不是数据融合）**

#### 3.3.1 产品估值点（ProductValuation）

- 字段：`product_id + date + market_value`
- 表示：你在某天看到的产品当前市值
- 特性：
  - 允许缺失
  - 不要求连续
  - 不回写、不修正

#### 3.3.2 现金流事件（Transaction）

所有交易都**绑定到产品**：

事件类型（MVP）：

- `buy`：买入（账户 → 产品）
- `redeem_request`：发起赎回
- `redeem_settle`：赎回到账（产品 → 账户）
- `fee`：手续费
- `income` / `expense` / `transfer`（非产品交易，可选）

关键字段：

- product_id（必填）
- account_id（必填，用于现金与对账）
- trade_date / settle_date
- amount

---

## 四、分析功能（P1）

### 4.1 产品市值序列（唯一分析输入）

**Product Market Value Series**：

- `manual`：真实估值点
- `interpolated`：插值点（用于连续性）

规则：

- 插值点仅存在于 Derived Series
- 插值点默认不参与“严格收益”计算

---

### 4.2 收益率展示策略（参考档）

> 本系统默认使用 **参考收益率**，用于辅助判断，而非精确比较。

#### 4.2.1 严格口径（少数情况）

仅当满足以下条件时：

- 区间内 **无现金流事件**
- 有效估值点（manual）≥ 2 周

才展示：

- 区间涨跌
- 简化年化

否则，严格收益 **不展示或灰显**。

---

#### 4.2.2 参考口径（默认展示）

在存在现金流或估值不连续时：

- 系统可计算 **参考收益率（近似）**
- 允许使用：
  - 插值市值
  - 现金流加权近似算法（如 Modified Dietz）

展示规则：

- 明确标注：**“参考值（含现金流，非精确）”**
- 不用于：
  - 产品间排序
  - 风险/收益比排名

---

### 4.3 风险类指标

- 最大回撤
- 回撤修复时间
- 波动（可选）

说明：

- 可使用插值点
- 必须提示“基于估值推导，可能受现金流影响”

---

## 五、资金可用性（P2）

### 5.1 立即可用现金

- is_liquid = true 的账户余额
- 扣除：近期负债
- **不包含**：已赎回未到账资金

### 5.2 未来可用现金

- 到期本息
- 已发起赎回的预计到账金额

---

## 六、页面与交互（概要）

### 6.1 Dashboard

- 总资产、流动资产、负债
- 到期/赎回提醒

### 6.2 产品详情页（核心）

- 产品规则卡片
- 记录区：
  - 买入 / 赎回操作
  - 估值点录入
- 展示区：
  - 市值走势（含插值标识）
  - 收益率（参考档 + 提示）
  - 风险指标

---

## 七、数据模型（概念层）

1. Institution
2. Account
3. Product
4. Transaction
5. ProductValuation
6. Snapshot

---

## 八、设计原则总结

- **先可用，再精确**
- **宁可近似，也不伪精确**
- **用户视角简单，系统内部复杂**
- **收益率是参考，不是结论**

> 本文档作为后续 Sprint 与实现的唯一需求基线。
> 未来若引入 Lot，将通过 Transaction 回放生成，不影响当前事实数据有效性。
