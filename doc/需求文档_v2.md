# 个人投资管理工具（需求文档 v2 · 精准定义版）

## 0. 数据分层与权威性（必须读）

### 0.1 四类数据的权威性
1. **Snapshot（资产快照）= 账面事实（最高权威）**  
   你在某天看到的余额就是事实；系统不会“纠正”它。
2. **Valuation Point（估值点）= 观察事实（允许缺失/不连续）**  
   你间断录入的“某日市值/当前价值”，可缺失、可不连续。
3. **Derived Series（推导序列）= 计算用（不回写事实表）**  
   插值/聚合/估算只用于图表与指标，不反向写回快照/估值点，避免污染事实。
4. **Metrics（指标）= 口径成立才展示，否则灰显/不可比**  
   数据不足（如 <2 周）或口径不成立（如区间内有买入/卖出）时，指标必须降级/提示。

### 0.2 对账原则（提示型，不阻断）
- **Snapshot 是权威**：如果某日 Snapshot 余额 ≠ 由 Transaction 推导的余额（超额超过5%），给出 warning（提示）而非纠正 Snapshot。

---

## 一、项目背景

本项目的目标是提升个人储蓄管理效率（将“记账”升级为“资金运营”）。

现在做法：
- **资产表**：按银行/账户维度记录余额、理财、信用卡负债（偏静态快照）
- **投资表**：每周末更新每个理财产品的净值/市值（偏行情/估值曲线）

用户痛点：
- **闲置资金识别不及时**：钱分散在不同账户、不同到期日、不同规则里
- **产品表现不可比**：本金不同、期限不同、收益浮动；仅看“涨了多少/收益率”会失真
- **无法形成决策闭环**：到期/可赎回时，系统不能自动提示“哪些钱会释放、可用现金是多少、下一步怎么投更稳”

---

## 二、核心功能

### 2.1 资金账本记录
把“账户-产品-批次-现金流-估值”统一成一个资金账本，还原：
- 钱从哪里来、去了哪里
- 现在值多少
- 未来什么时候能动（可用现金）

### 2.2 收益数据分析（分两类：产品表现 vs 你的收益）
- **产品表现（可比性）**：以“产品市值序列”为输入，优先提供风险/稳定性指标（回撤、波动等）；收益类指标在口径不成立时降级。
- **你的收益（资金效率）**：以现金流（买入/赎回/收益/手续费）为输入，最终用 XIRR 反映“这笔钱真实赚了多少”（但只在流水足够完整时展示）。

### 2.3 资金机会管理
输出：
- 今天哪些钱是**可立即再投资**的？
- 未来 7/30/90 天会释放多少资金？
- 在候选产品池里，按“稳健优先”的规则，怎么分配更合理？

---

## 三、记录功能（P0）

### 3.1 资产与账户管理
对象：银行、账户、信用卡负债等  
功能：
- 账户列表：活期/借记卡/券商资金/信用卡/其他
- 账户快照：余额、可用余额、冻结/待清算（若能区分）
- 负债：信用卡账单、还款日、最低还款（MVP 可手工填）

关键点：账户与产品的关系要清晰：资金从账户流入产品（申购），赎回后回到账户（到账时间可能滞后）。

---

### 3.2 投资产品与持仓管理（Lot 为核心）

产品主数据字段：
- 银行/产品名/产品代码（可自定义）
- 风险等级（R1-R5，外部标签）
- 运作方式：封闭式/定开/开放式
- 规则：起息/到期、是否可赎回、赎回到账 T+N、开放赎回窗口（可选）
- 费率/申赎规则（MVP 可先备注）

**Lot（批次持仓）**：每次买入形成一个 Lot，用来解决“同一产品多次买入/不同本金/不同起息”的现实问题。  
- 同一产品多次买入必须拆 Lot，否则收益与可用资金会乱。

---

### 3.3 现金流事件录入（Transaction）
统一用“现金流事件”建模，把“我做了什么”记录清楚。

#### 3.3.1 两个日期必须区分
- `trade_date`：动作发生日（你在 App 点了申购/赎回/转账）
- `settle_date`：资金到账/扣账日（可能 T+N；可为空）

> 现金可用性和“赎回≠到账”的所有逻辑，都依赖这两个日期的区分。

#### 3.3.2 类别（MVP）
- `buy`：申购/买入（账户流出，Lot 增加）
- `redeem_request`：发起赎回（Lot 减少，现金进入“redeeming”）
- `redeem_settle`：赎回到账（账户流入，现金变为可用或账户余额增加）
- `income`：工资/收入/外部注入（账户流入）
- `expense`：个人消费/外部支出（账户流出）
- `transfer`：账户间转账（不改变净资产，只改变位置）
- `fee`：手续费（账户流出）
- `dividend`：分红/收益到账（账户流入或 Lot 增加；MVP 先记为现金流入）

---

### 3.4 净值与估值录入（Valuation Point）
现实约束：你只能**间断**记录“某日当前市值金额”，不保证每日净值/NAV。

#### 3.4.1 两种估值录入口径（都允许）
- **产品估值点（ProductValuation, manual）**：按 `product_id + date` 录入 `market_value`  
  用于：当你只有产品总市值、没有批次拆分数据时。
- **批次估值点（LotValuation）**：按 `lot_id + date` 录入 `market_value`  
  用于：你能拿到每一笔买入批次当天的“当前市值金额”。

#### 3.4.2 产品市值序列（唯一图表/指标输入）
所有产品图表与指标只消费 **Product Market Value Series**，其合成规则为：

对每个 `product_id + date`：
1. 若存在 **手工产品估值点（manual）** → 使用 manual
2. 否则使用 **批次估值聚合（derived）**：
   - `derived_value(date) = Σ lot_value(date)`（仅统计在持有范围内的 lot）

并返回标记：
- `source`: `manual | derived`
- `partial`: 当日并非所有 holding lot 都有估值点时为 true（仍可画图，但默认不参与指标计算）

---

## 四、分析功能（P1）

### 4.1 指标分级与展示规则（Option A：走势优先、收益降级）

#### 4.1.1 数据充分性（硬门槛）
- 有效估值点（剔除 partial）≥ 2 周：才展示指标
- 否则：指标灰显 + “数据不足，暂不支持对比”

#### 4.1.2 区间内现金流导致“收益不可比”
当窗口区间内发生以下事件之一：
- buy（新增 lot）
- redeem_request / redeem_settle（减少 lot 或资金回流）
- income / expense / transfer（影响账户资金）

则：
- 收益类指标（区间涨跌、年化、TWR）**标记为“参考值/不可比”**并提示：
  > “区间内发生资金流动，当前收益未剥离现金流影响。”
- 风险类指标（最大回撤、回撤修复天数、波动）仍可展示，但同样提示“受资金流影响”。

> 解释：你现在的估值点是间断的、现金流也可能不完整；本阶段不做严格剥离现金流的 TWR/XIRR，避免误导。

#### 4.1.3 本阶段支持指标（以产品市值序列为输入）
- 区间涨跌幅：`V_end / V_start - 1`（可降级）
- 年化（按周/按天口径，需写死）：`(V_end / V_start)^(365/天数) - 1`（可降级）
- 最大回撤
- 回撤修复时间
- 波动（可选，周频）

---

## 五、预测功能（P2）

闲置资金识别与“资金可用性”设计为两类“可用现金”：

### 5.1 立即可用现金（Today Available）
- 活期/可用余额（配置 `is_liquid=true` 的账户）
- 扣除：预留金、近期信用卡还款（MVP 可手工填）
- **不包含**：redeeming（已赎回未到账）的资金

### 5.2 未来可用现金（Forecast）
- 封闭/定开：到期日/开放赎回日
- 已发起赎回：预计到账日（T+N）
- 定期计息：到期本息（可由规则推导）

---

## 六、页面与交互设计（概要）

### 6.1 首页仪表盘
- 总资产、流动资产、负债、可用现金
- 资产分布
- 预警：到期/开放赎回、信用卡还款日、闲置资金

### 6.2 账户页
- 账户列表（按机构分组）
- Snapshot 录入与查看
- 账户流水（Transaction）

### 6.3 产品页（对比与决策核心）
- 产品规则卡片
- 估值曲线（来自产品市值序列）
- 指标（按 Option A 降级规则展示）
- 你的 Lot 列表（每次买入一行）：本金、起息、状态、当前估值（来自 LotValuation 或派生）

### 6.4 对比页
- 筛选：机构/期限/风险/是否可赎回
- 排序：最大回撤、回撤修复、（可选）收益-回撤比
- 收益类排序在现金流不成立时提示“不可比”

### 6.5 现金流日历
- 预计到账、到期本息、开放赎回窗口
- 闲置资金提醒

### 6.6 导入导出
- Excel 导入：资产表（Snapshot）、投资表（估值点）
- 导出：月报/年报

---

## 七、数据模型（概念层，按 v2 口径修正）

1. **Institution（银行/平台）**
   - id, name

2. **Account（账户）**
   - id, name, type（cash/debit/credit/investment_cash/other）
   - institution_id
   - is_liquid（是否计入流动资产）

3. **Product（理财产品）**
   - id, institution_id, name, risk_level(R1-R5), structure(封闭/定开/开放), t_plus_n, rules(备注)

4. **Lot（批次持仓）**
   - id, product_id
   - open_date, principal
   - status（holding/closed）  ※ redeeming/settled 为 Sprint4+ 扩展
   - close_date（可空）
   - note

5. **RedemptionAllocation（指定批次赎回分配）**（本期可先定义，不要求实现完整自动推导）
   - id
   - redemption_id（一次赎回动作）
   - lot_id（**必须指定**）
   - principal_redeemed（从该 lot 赎回的本金）
   - trade_date
   - settle_date（可空）
   - status（redeeming/settled）

6. **Transaction（现金流事件）**
   - id
   - account_id
   - product_id（可空）
   - lot_id（可空）
   - category（buy/redeem_request/redeem_settle/income/expense/transfer/fee/dividend）
   - trade_date
   - settle_date（可空）
   - amount（约定：账户流入为正，流出为负；transfer 需要 from/to 两条或额外字段）

7. **ProductValuation（产品估值点）**
   - product_id, date, market_value
   - source（manual/derived）※ derived 不必落库，可运行时计算

8. **LotValuation（批次估值点）**
   - lot_id, date, market_value

9. **Snapshot（资产快照）**
   - date, account_id, balance（允许负数）

---

## 八、业务术语（精确定义表）

> 每个术语必须回答：**是什么 / 权威来源 / 允许缺失吗 / 用在哪里 / 不成立时怎么办**

### 8.1 Snapshot（资产快照）
- 是什么：某日看到的账户余额
- 权威：最高
- 缺失：允许
- 用在哪里：Dashboard、资产历史、对账 warning
- 不成立：不适用（事实）

### 8.2 Transaction（现金流事件）
- 是什么：资金流动事件（买入、赎回、到账、转入转出、转账）
- 权威：次于 Snapshot（可不完整）
- 缺失：允许（但会导致 XIRR/严格收益不可算）
- 用在哪里：可用现金、未来到账预测、（未来）严格收益率
- 不成立：流水缺失 ⇒ 指标灰显或提示“数据不足”

### 8.3 Lot（批次持仓）
- 是什么：一次买入形成的一笔持仓
- 权威：由你录入（事实）
- 缺失：不允许（同一产品多次买入必须拆 Lot）
- 用在哪里：产品持仓表、批次估值、（未来）赎回状态机

### 8.4 指定批次赎回（RedemptionAllocation）
- 是什么：一次赎回动作**明确指定**从哪些 Lot 赎回多少本金
- 权威：由你录入（事实）
- 缺失：允许（缺失则无法精确拆分批次收益）
- 用在哪里：批次剩余本金、赎回日从投资中扣除、redeeming 现金不可用
- 约束：同一赎回下，`Σ principal_redeemed ≤ lot.principal_remaining`（按 lot 逐条校验）

### 8.5 Valuation Point（估值点）
- 是什么：你在某日能拿到的“当前市值金额”（产品级或批次级）
- 权威：观察事实（可间断）
- 缺失：允许
- 用在哪里：走势、风险指标
- 不成立：估值不足 ⇒ 指标灰显/不可比

### 8.6 Product Market Value Series（产品市值序列）
- 是什么：产品级的时间序列市值（图表/指标唯一输入）
- 权威：推导结果（manual 覆盖优先，其次 derived 聚合）
- 缺失：允许
- partial：当日 holding lots 估值不齐 ⇒ partial=true（可画图，不参与指标默认计算）

---

## 附录：需求澄清（保留为决策记录）
- Snapshot 是权威；Snapshot 与 Transaction 推导不一致时给 warning（提示型）。  
- 非净值型产品收益确认时点隐含计入估值；你会定期更新估值点，系统允许插值但不回写事实。  
- 风险等级 R1–R5 是外部标签。  
- 赎回日不计入投资市值；到账前资金不算可用现金；状态机 holding/redeeming/settled 合适（Sprint4+）。  
- 赎回按**指定批次**。  
- 允许起始估值点不完整：指标只在数据足够时展示（如 ≥2 周），缺失数据给“不可比/灰显”。
