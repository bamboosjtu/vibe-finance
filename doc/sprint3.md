# Sprint 3：产品详情页 & 走势核心（v3 对齐版）

> 需求基线：`需求文档 v3· 参考收益版`  
> Backlog 基线：`sprint_backlog.md`  
> 核心定位：**录入融合 · 走势可信 · 收益参考 · 不误导**

---

## 一、Sprint 3 的角色定位（必须先统一）

### 🎯 Sprint Goal（冻结）

在 **一个产品详情页** 内完成：

- 买入 / 卖出 / 估值的统一录入
- 可区分“观察点 / 插值点 / 资金事件”的产品市值走势
- 以**参考档**为主的收益与风险指标展示

> 本 Sprint 的成功标准不是“收益算得准”，  
> 而是 **“走势看得懂，哪里是市场、哪里是自己心里有数”**。
> 本 Sprint 中，系统只存在一种估值事实：**产品级估值（ProductValuation）**。  
> 不区分产品估值与批次估值。

---

## 二、Sprint 3 的明确边界（防止实现越界）

### 本 Sprint **不做**

- Lot / 批次的任何 UI
- 批次估值（LotValuation）
- 精确 TWR / XIRR
- 自动收益拆分（本金 vs 收益）
- 不维护 InternalHolding（不生成、不分配、不建表），未来如需精细分析，可基于 Transaction 回放重建。

### 本 Sprint **必须做到**

- 产品详情页成为**唯一操作入口**
- 走势中清晰区分：
  - 观察估值
  - 插值估算
  - 买入 / 卖出事件
- 收益率明确标注为“参考值”

---

## 三、数据口径与分层（Sprint 3 只认这一套）

### 3.1 数据分层

| 层级 | 名称                        | 说明                       |
| ---- | --------------------------- | -------------------------- |
| 事实 | Snapshot                    | 账户余额快照，最高权威     |
| 事实 | ProductValuation            | 产品级估值点（人工录入）   |
| 事实 | Transaction                 | 买入 / 卖出 / 到账等现金流 |
| 推导 | Product Market Value Series | 图表与指标唯一输入         |
| 展示 | Metrics                     | 参考收益 / 风险指标        |

### 3.2 冻结原则

- 插值、收益近似 **不回写事实表**
- Snapshot 不被推导结果纠正
- 不因数据缺失报错或“强行算完整”
- ProductValuation 是唯一估值录入口径，不存在批次级估值事实

---

## 四、页面与能力拆解（按实现顺序）

## S3-1 产品详情页：统一录入【必做】

### 页面结构（固定）

1. **产品规则区**
   - 产品名、风险等级、赎回规则（T+N）

2. **记录区（录入）**
   - 产品估值点录入
   - 买入 / 赎回 / 到账操作

3. **展示区**
   - 市值走势
   - 收益与风险指标

---

### 4.1 产品估值点录入（ProductValuation）

**字段**

- product_id
- date
- market_value

**规则**

- 允许缺失、不连续
- 同日覆盖不报错
- 不自动补齐

**验收**

- 可快速补录历史估值
- 不影响既有走势正确性

---

### 4.2 交易录入（Transaction，绑定产品）

**支持类型**

- buy
- redeem_request
- redeem_settle
- fee

**关键字段**

- product_id（必填）
- account_id（必填）
- trade_date / settle_date
- amount

**交易规则**

- 本阶段不做批次/分配；买入卖出仅作为产品级现金流事件参与走势标注与参考收益。

**验收**

- 多次买入、部分赎回可正确记录
- 赎回未到账期间不计入可用现金（Sprint 4 深化）

---

## S3-2 产品市值序列生成（Derived）【必做】

### 输入

- ProductValuation（manual）

> 本 Sprint 不支持、也不预留任何基于批次（InternalHolding）的估值聚合逻辑。

### 插值规则（冻结）

- 仅在 **两个 manual 估值点之间** 生成插值点
- manual 覆盖范围之外：仍会补齐（单点会向后补；最后一个 manual 点后也会补到 end_date）
- 内部插值点标记：`source = interpolated`
- 外部插值点标记：`source = extrapolated`

### 输出

**Product Market Value Series**

- date
- value
- source（manual / interpolated / extrapolated）

---

## S3-3 走势可视化（Sprint 3 核心价值）【最高优先级】

### 3.3.1 点与事件的视觉语义（必须区分）

#### 观察点（manual）

- 实心点
- 高对比色
- Tooltip：
  > 观察估值（人工录入）

#### 插值点（interpolated）

- 空心点 / 虚线
- Tooltip：
  > 插值估算，仅用于走势连续性参考

#### 买入 / 卖出事件

- 垂直事件线
- 不同颜色区分 buy / redeem
- Tooltip 显示：
  - 类型
  - 金额
  - 日期

> 图中所有估值点（观察点 / 插值点）均表示**产品整体市值**，

---

### 3.3.2 Y 轴范围处理（冻结规则）

**问题**

- 大额买入 / 赎回会造成市值台阶变化
- 自动缩放可能压扁历史波动

**规则**

1. Y 轴基于：
   - 市值序列（manual + interpolated）
   - 并考虑买入 / 卖出当日的市值跳变
2. 极端资金流动时：
   - 不压缩历史走势到不可读
   - 可增加 padding 或显示断轴提示
3. Tooltip 必须说明：
   - 市值变化是否来自资金流动

**验收**

- 用户能直观看出：
  - 市场变化
  - 自身资金操作

---

## S3-4 收益与风险指标（参考档）【必做】

### 4.1 参考收益率（默认展示）

- 使用插值市值 + 现金流近似算法
- 展示文案固定：
  > 参考值（含资金流动影响，非精确）

**限制**

- 不用于产品排序
- 不作为决策结论

> 参考收益率基于：产品级市值变化 + 产品相关现金流近似计算，  
> 不基于任何批次级估值或批次收益拆分。

---

### 4.2 严格收益（条件展示）

仅当：

- 区间内无现金流
- manual 估值点 ≥ 2 周

才展示：

- 区间涨跌
- 简化年化

否则：

- 灰显或不展示

---

### 4.3 风险指标

- 最大回撤
- 回撤修复时间
- 波动（可选）

**说明**

- 可使用插值点
- 必须提示“可能受资金流影响”

---

## 五、常见边界场景（验收必须覆盖）

1. **只录估值，不录交易**
   - 走势正常
   - 严格收益可算

2. **多次买入 + 少量估值**
   - 走势可画
   - 收益仅参考

3. **大额买入导致市值跳变**
   - Y 轴不压扁历史波动
   - 事件线清晰可见

4. **插值密集**
   - 插值点永远弱于观察点
   - 不参与严格收益

---

## 六、Sprint 3 完成定义（DoD）

当我在一个产品页中：

- 能完成所有真实操作（买 / 卖 / 估值）
- 一眼分清哪些是事实、哪些是估算
- 不会被收益率误导为“精确结果”

则认为 Sprint 3 成功。
