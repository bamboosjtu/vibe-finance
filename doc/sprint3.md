# Sprint 3 实现清单

**主题：产品估值 & 可比性（TWR / 年化 / 回撤）**
**目标**：在不依赖交易流水的前提下，让理财产品“可比、可信、稳健优先”


## 修改后的 Sprint 3 实现文档（基于 Lot 和估值）

### **主要修改内容**：

1. **Lot 的概念**：我们已经在 Sprint 1 中补充了 Lot，现在需要调整 Sprint 3 中的“产品估值”和“TWR计算”部分，使其支持 Lot。
2. **估值录入**：现在我们不仅仅需要“产品估值”，还需要为每个 Lot 录入估值数据。

---

## 🎯 Sprint 3 Goal（更新后的目标）

> 我可以只依赖**产品估值曲线**和**持仓批次估值**，
> 判断不同理财产品的**表现与稳定性**，
> 并且这些判断不受我个人申赎时点影响。

---

# T3-1 产品估值（Product Valuation）录入

### 任务

支持为产品和每个 Lot 录入**非每日、不连续的估值金额**，作为后续一切分析的原始输入。

---

### 接口

#### POST /api/lot-valuations/batch_upsert

> 新增接口：为每个 Lot 录入估值数据

**用途**：手工录入 / 后续 Excel 导入复用

**请求**

```json
{
  "source": "manual",
  "rows": [
    { "lot_id": 9001, "date": "2024-12-30", "market_value": 100000.00 },
    { "lot_id": 9001, "date": "2025-01-05", "market_value": 100059.46 }
  ]
}
```

**响应**

```json
{
  "inserted": 2,
  "updated": 0,
  "warnings": []
}
```

#### GET /api/lots/{lotId}/valuations?from=2024-12-01&to=2025-01-31

**响应**

```json
{
  "lot_id": 9001,
  "points": [
    { "date": "2024-12-30", "market_value": 100000.00 },
    { "date": "2025-01-05", "market_value": 100059.46 }
  ]
}
```

---

### 页面

#### 产品估值录入页（MVP 形态）

**交互**：

* 选择 Lot
* 表格：

  * 日期
  * 市值金额
* 支持快速多行录入

**行为**：

* 同日再次录入即覆盖
* 不提示“是否合理”（MVP 不校验）

---

### 验收标准

* [ ] 能录入 Lot 的估值数据
* [ ] 中间缺失日期不报错
* [ ] 数据与实际银行 APP 报告一致

---

# T3-2 估值时间序列 & 插值（仅计算层）

### 任务

为计算指标准备**连续时间序列**，但不污染原始数据。

---

### 实现规则（必须遵守）

* 插值 **只存在于计算内存中**
* 原始 `lot_valuations` 表不写回
* 插值方式（MVP）：

  * 按日线性插值
  * 或按周对齐（可选，先简单）

> 目的不是“精确还原每日收益”，
> 而是让 **回撤 / 波动 / 年化** 有连续基准。

---

### 接口（内部服务）

`getValuationSeries(lot_id, from, to, interpolate=true)`

**输出示意**

```json
[
  { "date": "2024-12-30", "value": 100000.00 },
  { "date": "2024-12-31", "value": 100011.89 },
  ...
  { "date": "2025-01-05", "value": 100059.46 }
]
```

---

### 验收标准

* [ ] 插值不影响原始数据
* [ ] 估值曲线视觉连续
* [ ] 插值仅用于“计算”，不是“展示事实”

---

# T3-3 产品收益与风险指标计算（核心）

### 任务

基于估值曲线，计算**不受申赎影响**的产品指标。

---

### 指标定义（你已确认的口径）

#### 周收益

[
r_t = \frac{V_t}{V_{t-1}} - 1
]

#### 区间累计

[
\prod (1 + r_t) - 1
]

#### 年化（周频）

[
\left(\frac{V_{\text{end}}}{V_{\text{start}}}\right)^{\frac{52}{\text{周数}}} - 1
]

#### 最大回撤

[
\max \left(1 - \frac{V_t}{\max(V_0..V_t)}\right)
]

#### 回撤修复时间

* 从峰值 → 回到该峰值所需时间

---

### 接口

#### GET /api/products/{id}/metrics?window=8w&scope=holding

**响应（正常）**

```json
{
  "product_id": 200,
  "window": "8w",
  "status": "ok",
  "metrics": {
    "twr": 0.0005946,
    "annualized": 0.00388,
    "volatility": 0.0012,
    "max_drawdown": 0.0003,
    "drawdown_recovery_days": 7
  }
}
```

**响应（数据不足）**

```json
{
  "product_id": 200,
  "window": "8w",
  "status": "insufficient_data",
  "metrics": null
}
```

---

### 验收标准

* [ ] 数据 ≥ 2 周才计算
* [ ] 不硬算、不 NaN、不除零
* [ ] 同一产品，多窗口结果合理变化

---

# T3-4 产品详情页（估值 & 指标）

### 任务

把“估值 + 指标”组合成一个**你能直觉判断好坏的页面**。

---

### 页面

#### 产品详情页（核心）

**模块**

1. 产品基本信息

   * 名称 / 机构 / 风险等级 / 期限 / 流动性
2. 估值曲线（折线）
3. 指标区

   * TWR
   * 年化
   * 最大回撤
   * 回撤修复时间

**交互**

* 窗口切换：4w / 8w / 12w
* 数据不足 → 灰显 + 提示文案

---

### 文案要求（很重要）

* 不显示指标时：

  > “数据不足（少于 2 周），暂不支持对比”

---

### 验收标准

* [ ] 我能直觉判断“这个产品稳不稳”
* [ ] 指标变化符合估值曲线走势
* [ ] 灰显逻辑让我安心而不是困惑

---

# T3-5 产品对比页（第一版）

### 任务

把多个产品放在一张表里，对齐比较。

---

### 页面

#### 产品对比页（MVP）

**筛选**

* 机构
* 风险等级
* 期限范围
* 流动性规则

**展示列**

* 产品名
* 年化收益
* 最大回撤
* 回撤修复时间

**排序**

* 默认：最大回撤 ↑（稳定优先）
* 可切换：年化 ↓ / ↑

---

### 行为规则

* 指标不足 → 行整体灰显
* 不参与排序

---

### 验收标准

* [ ] 日日金 / 28D / 63D / 91D 能放一起
* [ ] 排序结果符合“稳健优先”的直觉
* [ ] 不会因为数据缺失误导决策

---

# Sprint 3 Exit Criteria（完成标准）

> Sprint 3 只有在你能**脱离 Excel**完成下面行为时，才算完成：

* [ ] 我能只看系统判断哪个理财更稳
* [ ] 我敢用这个对比结果指导下一次买入
* [ ] 我不需要关心自己什么时候买的

---

## 🧠 Sprint 3 的产品价值总结

> **到 Sprint 3，你已经拥有一个“理财产品研究工具”。**

* Snapshot 给你 **事实**
* 估值曲线给你 **走势**
* TWR / 回撤给你 **可比性**

后面的 Sprint（交易 / XIRR / 预测），
**是在这个坚实地基上加“个人行为维度”**。

---

## 修改要点总结：

1. **新增了 Lot 的估值录入（`lot_valuations`）**，并相应调整了接口与页面。
2. **TWR 计算和回撤分析**：使用 Lot 估值来处理每个批次的表现。
3. 在**产品对比页和产品详情页**中，明确区分“持仓估值”和“产品表现”曲线。
