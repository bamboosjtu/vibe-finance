# Sprint 2 实现清单

**主题：资产快照 & Dashboard v1**
**目标**：把“某一天我真实的资产状态”可靠地记录下来，并一眼看清全局

---

## 🎯 Sprint 2 Goal

> 我可以为任意一天录入资产快照，
> 并在 Dashboard 上**准确看到总资产、流动资产、负债结构**，
> 且我相信这些数字就是“事实”。
> 本 Sprint 不涉及产品收益或走势分析。
> 本阶段不维护 Lot / InternalHolding（不建表、不生成、不分配）；未来如需精细分析，可基于 Transaction 回放重建。

---

## 📋 扩展字段说明（Sprint 2 新增）

### GET /api/accounts 扩展字段

Sprint 2 为账户列表接口增加了**最近一次快照信息**，便于 Snapshot 录入页预填和历史追溯：

**响应（完整）**

```json
{
  "items": [
    {
      "id": 10,
      "name": "长沙银行-借记卡",
      "type": "debit",
      "is_liquid": true,
      "latest_balance": 6156.16,
      "latest_date": "2025-01-05"
    }
  ]
}
```

**扩展字段说明**

| 字段 | 类型 | 说明 |
|------|------|------|
| `latest_balance` | number/null | 该账户最近一次快照的余额，无快照时为 null |
| `latest_date` | string/null | 最近一次快照的日期（ISO 格式），无快照时为 null |

**使用场景**

- **Snapshot 录入页**: 展示上次余额作为参考，方便用户对比变化
- **账户总览**: 快速了解各账户最新状态，无需额外查询

> **注意**: 这两个字段是 Sprint 2 新增的**扩展字段**，不属于 Account 核心模型，仅用于列表查询场景。

---

# T2-1 资产快照（Snapshot）录入

## 任务

实现 **以日期为核心的资产快照录入与查询**，并明确 Snapshot 的权威地位。

---

### 接口

#### POST /api/snapshots/batch_upsert

**用途**：同一日期，多账户一次性录入/覆盖

**请求**

```json
{
  "rows": [
    { "date": "2025-01-05", "account_id": 10, "balance": 6156.16 },
    { "date": "2025-01-05", "account_id": 11, "balance": -4048.06 }
  ]
}
```

**实现规则**

- `(date, account_id)` 唯一
- 同日再次提交 → 覆盖
- 不校验“是否与交易一致”

**响应**

```json
{
  "inserted": 2,
  "updated": 0,
  "warnings": []
}
```

---

#### GET /api/snapshots?date=2025-01-05

**响应**

```json
{
  "date": "2025-01-05",
  "items": [
    { "account_id": 10, "balance": 6156.16, "date": "2025-01-03" },
    { "account_id": 11, "balance": -4048.06, "date": "2025-01-05" }
  ]
}
```

**扩展字段说明**

| 字段 | 类型 | 说明 |
|------|------|------|
| `items[].date` | string | 该条余额实际对应的快照日期（ISO 格式）|

> **使用场景**：当使用 `fill=true` 参数时，系统会返回最近一次有快照的日期作为 `items[].date`，可能与查询日期不同。例如查询 2025-01-10 但返回的是 2025-01-05 的快照数据，前端可通过此字段告知用户数据来源日期。
>
> **注意**：此字段属于 Sprint 2 新增的**扩展字段**，用于支持 "用最近快照填充" 的场景，不属于 Snapshot 核心模型。

---

### 页面

#### 资产快照录入页（核心页面之一）

**交互模型（很重要）**

- 日期选择器（默认今天）
- 表格：
  - 行 = 账户
  - 列 = 余额

- 一次性保存

**行为规则**

- 切换日期 → 重新加载该日快照
- 该日无数据 → 余额列为空
- 输入即覆盖，不弹确认（MVP 简洁优先）

---

### 验收标准

- [x] 同一天可以录入多个账户余额
- [x] 覆盖同日数据不会产生重复
- [x] 不需要任何交易流水就能工作
- [x] 我可以放心地说：**这就是事实，不是推算**

---

# T2-2 Snapshot 查询 & 汇总计算

## 任务

从 Snapshot 中计算**可解释的汇总指标**，供 Dashboard 使用。

---

### 接口

#### GET /api/dashboard/summary?date=2025-01-05

（可直接在 Dashboard Controller 内实现）

**返回口径**

- 总资产 = 所有账户 balance 之和
- 流动资产 = `is_liquid = true` 的账户 balance 之和
- 负债 = `type = credit` 的账户 balance 之和（负数）
- 可用现金 = 流动资产 + 负债（即流动资产扣除信用卡欠款后的净流动资产）

**响应**

```json
{
  "date": "2025-01-05",
  "total_assets": 1506755.38,
  "liquid_assets": 1057587.35,
  "liabilities": -4048.06,
  "available_cash": 1053539.29,
  "by_type": {
    "cash": 16669.3,
    "debit": 6158.76,
    "credit": -4048.06,
    "investment_cash": 1038807.35,
    "other": 1516.79
  }
}
```

**扩展字段说明**

| 字段 | 类型 | 说明 |
|------|------|------|
| `available_cash` | number | 可用现金 = 流动资产 + 负债（负债为负，故实际是流动资产减去信用卡欠款）|

> **计算示例**：`available_cash = 1057587.35 + (-4048.06) = 1053539.29`
>
> **注意**：此字段属于 Sprint 2 新增的**扩展字段**，表示扣除负债后的净流动资产，便于用户快速了解"实际可支配"资金。

---

### 页面

#### Dashboard v1（快照视角）

**核心模块**

1. 日期选择（与 Snapshot 页一致）
2. 指标卡片
   - 总资产
   - 流动资产
   - 负债

- 流动资产（基础版） **【修改】Sprint 2 仅展示 is_liquid 汇总的“流动资产（基础版）”，不等同严格可用现金（不扣预留金/还款/赎回在途）。**

3. 资产结构
   - 按账户类型分组（简单列表或饼图）

**交互规则**

- 切换日期 → 所有指标联动更新
- 指标「流动资产（基础版）」口径：`is_liquid=true` 账户余额汇总；**不**包含赎回在途、也不扣除预留金/还款（后续 Sprint 再升级为严格“可用现金”）。 **【修改】补充口径说明**
- 无 Snapshot 数据 → 日期不可选择，提示“该日无记录”
- 默认显示最近有 Snapshot 的日期

---

### 验收标准

- [x] Dashboard 数字 = Snapshot 直接汇总
- [x] 页面命名为「流动资产（基础版）」而非「可用现金」，避免口径误解 **【修改】新增**
- [x] 不依赖任何估值/交易
- [x] 数值“看起来就是我 Excel 里的那一行”

---

# T2-3 Snapshot 权威性验证（为后续铺路）

## 任务

建立 **Snapshot 与 Transaction 的“对账框架”**（先不真正计算）。

---

### 接口（占位）

#### GET /api/reconciliation/warnings?date=2025-01-05

**当前阶段返回**

```json
{
  "items": [],
  "note": "交易流水尚未启用，对账将在 Sprint 6 开始"
}
```

---

### 页面

#### Dashboard 轻提示（非阻断）

- 区域：Dashboard 底部或角落
- 文案：

  > “当前资产数据来源于资产快照，交易对账将在后续版本启用”

---

### 验收标准

- [x] Snapshot 不被任何逻辑“纠正”
- [x] 对账逻辑明确是“提示型”
- [x] 用户不会误以为系统在自动算资产

---

# T2-4 前后端联调 & 使用验证

## 任务

确保 Snapshot → Dashboard 的闭环真实可用。

---

### 联调清单

- [x] 新建账户 → 出现在 Snapshot 表格
- [x] 录入 Snapshot → Dashboard 实时变化
- [x] 改某账户余额 → 总资产同步变化
- [x] 切换日期 → 所有数据跟随

---

### Sprint 2 Exit Criteria（完成标准）

> 只有当你能**不用 Excel**，
> 仅靠系统完成下面这件事，Sprint 2 才算完成：

- [x] 我能为某一天录入全部资产
- [x] 我能一眼看到当天的资产全貌
- [x] 我相信这些数是“事实”，不是“算出来的”

---

## 🧠 Sprint 2 的产品价值总结（给未来的你）

> **到 Sprint 2 结束，你已经拥有一个“可靠的个人资产台账”。**
