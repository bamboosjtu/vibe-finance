# 个人投资管理工具（开发口径版 PRD）

> 本文档用于指导**功能实现与数据建模**，所有口径已明确，禁止在实现中自行推断或替换。

---

## 一、项目目标（工程统一认知）

本项目是一个 **以资产快照为权威、以现金流为分析工具、以资金可用性为核心输出** 的个人投资管理系统。

**核心目标不是记账，而是回答三个问题：**

1. 我现在的钱分布在哪里，哪些能用？
2. 不同理财产品在**统一口径下**谁更稳、更好？
3. 未来一段时间，我什么时候会有钱可再投资？

---

## 二、核心设计原则（必须遵守）

### 2.1 权威数据源原则（非常重要）

* **资产快照（Snapshot）是权威事实**

  * Snapshot 代表某日真实资产状态
  * 不假设其可由交易流水完全推导
  * 原因：部分银行理财不提供每日收益/流水

* **交易流水（Transaction）是分析工具**

  * 用于计算 XIRR、预测现金流
  * 不反向修正 Snapshot

⚠️ 若某日：

```
由 Transaction 推导的余额 ≠ Snapshot
```

➡️ **必须给出 Warning**

* 不自动修正
* 不中断计算
* 用于提示数据不完整或口径差异

---

### 2.2 投资收益确认原则（非净值型）

* 定期 / 非净值型产品：

  * **收益每日隐含计入估值**
  * 估值可能不是每日更新，允许插值
  * 银行 APP 会给出“当前价值”，系统需支持

* 不采用“只在到期日确认收益”的模式
  （否则长期理财产品无法横向比较）

---

### 2.3 风险等级原则

* R1–R5 为 **外部标签**

  * 由销售方提供
  * 系统不计算、不修正
  * 仅用于筛选、展示

---

## 三、功能范围与优先级

### P0：记录与基础分析（必须完整）

* 资产与账户管理
* 投资产品与持仓（Lot）
* 交易流水
* 净值 / 估值录入
* Snapshot–Transaction 差异告警

### P1：分析指标

* TWR / XIRR / 年化
* 波动 / 回撤 / 回撤修复时间
* 产品对比

### P2：预测与决策支持

* 资金可用性预测
* 闲置资金提醒
* 现金流日历

---

## 四、数据模型（开发视角）

### 4.1 Snapshot（资产快照）【权威】

* date
* account_id
* balance（允许负数）
* 用途：

  * 资产分布
  * 趋势展示
  * 可用现金计算基准
  * 校验流水一致性

---

### 4.2 Account（账户）

* type：cash / debit / credit / investment_cash / other
* is_liquid：是否计入流动资产
* 信用卡：

  * 作为负资产
  * **不参与收益计算**

---

### 4.3 Product（理财产品）

* name / institution
* risk_level（R1–R5，外部标签）
* term_days
* liquidity_rule（open / closed / periodic）
* settle_days（T+N）

---

### 4.4 Holding / Lot（持仓批次）

* 一个 Lot = 一次申购
* 必须支持：

  * 多 Lot
  * **指定批次赎回**

---

### 4.5 Transaction（交易流水）

* 现金流模型
* amount：

  * 流出为负
  * 流入为正
* 用途：

  * XIRR
  * 现金流预测
  * 对 Snapshot 的一致性校验

---

### 4.6 ProductValuation（产品估值）

* date
* product_id
* market_value（金额）
* 允许：

  * 非每日
  * 缺失
  * 插值

---

## 五、持仓状态机（必须严格实现）

### 5.1 状态定义

| 状态        | 含义                    |
| --------- | --------------------- |
| holding   | 在投，计入投资市值             |
| redeeming | 已赎回，未到账，不计投资市值、不算可用现金 |
| settled   | 已到账，计入现金账户            |

### 5.2 状态切换规则

```
holding --(赎回)--> redeeming --(到账)--> settled
```

* **赎回日**：

  * 从投资市值中扣除
* **到账前**：

  * 不计入可用现金

---

## 六、收益与风险指标口径

### 6.1 TWR（时间加权收益）

* 基于估值序列
* 不受申赎影响
* 用于评价“产品本身表现”

### 6.2 XIRR（资金加权收益）

* 基于现金流
* 输入：

  * 申购 / 赎回 / 到账
  * 期末估值作为虚拟现金流
* 用于评价“我买得好不好”

### 6.3 数据不足处理

* 若有效估值点 < 2 周：

  * 不计算指标
  * 显示为 **不可比 / 灰显**
* 禁止硬算、禁止外推

---

## 七、现金可用性规则（决策核心）

### 7.1 Today Available（立即可用）

```
可用现金 =
Σ（is_liquid = true 的账户余额）
- 预留金
- 近 N 天需还款金额
```

* redeeming 状态资金 ❌
* holding 状态资金 ❌

---

### 7.2 Forecast Available（未来可用）

来源：

* 产品到期日
* 开放赎回日
* 已赎回资金的预计到账日（T+N）

输出：

* 7 / 30 / 90 天现金释放预测
* 现金流日历

---

## 八、页面实现约束（摘要）

* Dashboard：**决策导向，不是报表**
* 产品页：

  * 同时展示 TWR / XIRR
  * 明确“这是产品好 / 你买得好”
* 对比页：

  * 收益 + 回撤并列
  * 稳定优先

---

# 附录 A：业务定义（开发必读）

---

## A1. XIRR（业务定义）

* 输入：
  `{date, amount}` 现金流序列
* 规则：

  * 申购 = 负
  * 到账 / 赎回 = 正
  * 期末估值 = 虚拟正现金流
* 输出：

  * 年化收益率
* 注意：

  * Snapshot ≠ XIRR 输入
  * Snapshot 仅用于校验

---

## A2. 现金可用性（业务定义）

* 可用现金 ≠ 账户余额
* redeeming 状态 ≠ 可用
* 信用卡负债：

  * 仅影响可用现金
  * 不计入收益模型

---

## A3. 投资状态机（业务定义）

```
[holding]
   |
   | 赎回
   v
[redeeming]
   |
   | 到账
   v
[settled]
```

* holding：参与估值、风险、收益
* redeeming：冻结态
* settled：回归现金

