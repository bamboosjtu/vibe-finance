# 个人投资管理工具

## 一、项目背景
本项目的目标是提升个人储蓄管理效率（将“记账”升级为“资金运营”）。

现在做法：
- **资产表**：按银行/账户维度记录余额、理财、信用卡负债（偏静态快照）
- **投资表**：每周末更新每个理财产品的净值（偏行情/估值曲线）

用户痛点：
- **闲置资金识别不及时**：因为钱分散在不同账户、不同到期日、不同规则里
- **产品表现不可比**：本金不同、期限不同、收益浮动；仅看“涨了多少/收益率”会失真
- **无法形成决策闭环**：到期/可赎回时，系统不能自动告诉你“该把钱挪去哪里更划算/更稳”

## 二、核心功能

### 2.1 资金账本记录
把“账户-产品-交易-估值”统一成一个资金账本，还原“钱从哪里来、去了哪里、现在值多少、未来什么时候能动”。

### 2.2 收益数据分析
用可比的收益指标评价不同期限/本金/浮动产品，至少要同时支持：

- **资金加权收益率（XIRR/MWRR）**：适合“我这笔钱真实赚了多少”
- **时间加权收益率（TWR）**：适合“产品本身表现如何（不被申购赎回时点影响）”
- **年化收益、波动、最大回撤、回撤修复时间**：适合“稳定利润”的目标

### 2.3 资金机会管理
识别“可用现金/未来可用现金”，并做产品对比与建议，核心输出是：
- 今天哪些钱是**可立即再投资**的？
- 未来 7/30/90 天会释放多少资金？
- 在你的候选产品池里，按“稳健优先”的规则，怎么分配更合理？


## 三、记录功能（P0）

### 3.1 资产与账户管理

**对象**：银行、账户、币种、信用卡负债/分期等
**功能**：

- 账户列表：活期/定期/理财资金账户/券商资金/信用卡
- 账户快照：余额、可用余额、冻结/待清算
- 负债：信用卡账单、还款日、利息/手续费、分期计划（可选）

**关键点**：账户和投资产品的关系要清晰：资金从账户流入产品（申购），赎回后回到账户（到账时间可能滞后）


### 3.2 投资产品与持仓管理

**产品类型建议**（可扩展）：

- 银行理财（净值型）
- 存款类（大额存单/定期）
- 货币类（活期理财/现金管理）
- 其他（基金/债基/国债你逆回购/股市ETF…未来扩）

**产品主数据字段**：

- 银行/产品名/产品代码（你自定义即可）
- 风险等级（R1-R5或自定义）
- 运作方式：封闭式/定开/开放式
- 期限与规则：起息日、到期日、是否可赎回、赎回到账T+N
- 费率/申赎规则（可简化为备注，后续再结构化）

**持仓（Position/Lot）**：必须能处理不同本金、不同起息、分批申购

* 同一产品多次买入要分“批次/份额”（Lot），否则收益会乱

### 3.3 交易流水录入

统一用“现金流”建模，把“我做了什么”记录清楚）

- 申购：账户现金流出，产品份额/本金增加
- 赎回：产品份额/本金减少，账户现金流入（可能 T+N）
- 分红/收益到账：现金流入（或份额增加）
- 手续费：现金流出
- 转账：账户之间现金流转移（对净资产不产生收益，只改变位置）

**为什么要现金流模型？**：因为 XIRR/MWRR 的输入就是现金流；而且闲置资金识别也靠现金流预测（未来到账、未来到期）。

---

### 3.4 净值与估值录入

支持两种模式：

- **净值型**（你现在记录的那类）：定期录入 NAV
- **非净值型**（定期/大额存单）：用利率规则自动计息生成“理论净值/估值曲线”

净值录入方式：

- 手工录入（手动输入每个日期的净值）

## 四、分析功能（P1）

### 4.1 收益评价指标

- **累计收益/TWR(时间加权收益率)**：适合直观展示，但不可比（期限不同会误导）
- **年化收益率（Annualized Return）**
    - 对持有期短/封闭期产品更可比
    - 简化版：
         年化 ≈ (期末价值/投入成本)^(365/持有天数) - 1
         对有多笔现金流时用 XIRR 更准
- **XIRR（资金加权收益率）**：最符合“我真实赚了多少”
    - 输入：按日期的现金流（买入为负，赎回/收益为正，期末市值当作最后一笔正现金流）
    - 输出：年化收益率
    - 用它你就能把不同本金、不同买入时间的产品放在同一个标尺上

> 建议：产品页同时展示 **TWR（产品表现）** 与 **XIRR（你的实际收益）**

* TWR：不被你申赎时点影响，更接近“产品本身好不好”
* XIRR：你在这个产品上做得好不好

---

### 4.2 风险评价指标

除了收益率外，还需要评价投资风险（R1/R2/R3/R4/R5）,也就是投资回报的“稳定性”，净值周频已经够用，尤其对银行理财这种低波动资产。

- **波动率（基于周净值）**
- **最大回撤（Max Drawdown）**
- **夏普/卡玛（可选）**
- **回撤持续时间**：从高点回落到修复的时间


## 五. 预测功能（P2）
闲置资金识别与“资金可用性”设计为两类“可用现金”：

### 5.1 立即可用现金（Today Available）

- 活期余额
- 已赎回但未下单的余额
- 扣除信用卡近期最低还款/预留金后的可用额（可选）

### 5.2 未来可用现金（Forecast）

- 封闭/定开产品：到期日/开放赎回日
- 已发起赎回：预计到账日（T+N）
- 定期计息：到期本息

输出两个关键视图：

* **未来 7/30/90 天资金释放曲线（现金流日历）**
* **“闲置资金提醒”规则**：比如某账户可用现金 > X 且超过 Y 天未投入

---

## 六、页面与交互设计

### 6.1 首页仪表盘（每天打开就能决策）

* 总资产净值、总收益（本月/今年/累计）
* 资产分布：账户现金、理财持仓、负债
* 今日可用现金 & 未来 30 天可用现金
* 预警：即将到期/开放赎回、信用卡还款日、闲置资金超阈值

### 6.2 账户页

* 银行分组 → 账户列表
* 账户流水（可筛选：转入/申购/赎回到账/手续费）
* 账户余额与“可用现金”计算说明

### 6.3 产品页（对比与决策核心）

* 产品规则卡片：期限、赎回、风险、到账T+N
* 净值曲线（周频）
* 指标：TWR、XIRR、年化、最大回撤
* 你的持仓批次（每次买入一行）：本金、起息、当前估值、浮盈亏、持有天数

### 6.4 对比页（“我该买哪个”）

筛选条件：

* 银行/期限范围/风险等级/是否可随时赎回
  排序维度：
* 近 1/3/6/12 月 TWR
* 你的 XIRR（看你自己买得是否合适）
* 最大回撤（稳定优先）
* “收益-回撤比”（简单可用：年化/最大回撤）

### 6.5 现金流日历（闲置资金与到期管理）

* 按日/周展示：预计到账、到期本息、赎回开放窗口
* 可生成“再投资待办”（你手动确认后变成下一步操作）

### 6.6 导出

* 导出报表：月报/年报（方便复盘）

---



## 七、业务术语


### 7.1 数据分层与权威性

#### 1) Snapshot（资产快照）

* **定义**：某日实际看到的账户余额（包含冻结或待清算资金）。
* **来源**：**最高权威**，不可篡改。
* **关键字段**：`account_id`, `date`, `balance`
* **允许缺失**：允许
* **用途**：总资产、负债、对账警告。

#### 2) Transaction（现金流事件）

* **定义**：与资金流动相关的事件，如买入、赎回、转账等。
* **来源**：现金流事件的记录。
* **关键字段**：`transaction_id`, `date`, `amount`, `product_id`, `account_id`, `category (buy/sell/transfer)`
* **允许缺失**：可选（部分资金流可能未完全记录）
* **用途**：外部资金流入/流出，用于计算收益和现金流。

#### 3) Lot（批次持仓）

* **定义**：每次买入理财产品形成的单独持仓单位。
* **来源**：由用户买入行为引起。
* **关键字段**：`lot_id`, `product_id`, `open_date`, `principal`, `status (holding/closed)`, `close_date`（可空）
* **允许缺失**：当存在赎回但未关闭的批次，`close_date` 可为空
* **用途**：用于表示“投资”并追踪其市值、盈亏。

#### 4) RedemptionAllocation（赎回分配）

* **定义**：部分赎回时，从某个批次中赎回的本金部分。
* **来源**：每次赎回时分配的本金部分。
* **关键字段**：`redemption_id`, `lot_id`, `principal_redeemed`, `trade_date`, `settle_date`
* **允许缺失**：`settle_date` 可为空
* **用途**：表示赎回的金额，影响赎回批次的剩余本金。

#### 5) ValuationPoint（估值点）

* **定义**：某日产品或批次的市场价值或估值。
* **来源**：手动录入或按批次计算的估值。
* **关键字段**：`product_id | lot_id`, `date`, `market_value`
* **允许缺失**：允许（如果未录入该日估值）
* **用途**：用于计算产品市值序列和收益。

#### 6) Product Market Value Series（产品市值序列）

* **定义**：某产品在一段时间内的市值序列，基于批次估值或手动估值计算。
* **来源**：由批次估值（`lot_valuations`）和手动产品估值（`product_valuations`）合成。
* **关键字段**：`product_id`, `date`, `market_value`, `source (derived/manual)`, `partial (boolean)`
* **允许缺失**：当某日期缺少估值时，返回 `partial=true`，提示不完整数据。
* **用途**：展示产品估值走势，计算产品指标（TWR、年化等）。

---

### 7.2 估值合成规则

#### 1) 产品市值序列的合成

* 估值来源：
  * **manual**：当 `product_valuations` 存在 `source = manual` 的记录时，**优先使用该估值**。
  * **derived**：当没有 `manual` 估值时，**使用批次估值的聚合**。
* **合成方式**：
  * 聚合：`Σ lot_valuations.market_value`（对所有 `lot_id` 进行聚合）
  * 按日期生成产品市值序列：每个日期的市值值为所有当日持有批次的市值总和。
* **partial 数据**：如果某日期没有完全录入所有批次的估值，该日期的市值为“部分数据”，标记 `partial = true`。

#### 2) 部分赎回的处理

##### 2.1) 赎回操作

* **定义**：赎回是指部分取出某个批次的资金，不影响整个批次的剩余本金，剩余本金继续计算收益。
* **赎回记录**：当赎回发生时，生成 `RedemptionAllocation`，表示赎回的本金部分。
* **赎回分配**：赎回金额按比例从批次剩余本金中分配。

##### 2.2) 部分赎回与批次状态

* 在赎回完成后，批次的状态（`status`）仍为 `holding`，但赎回金额从批次的本金余额中扣除。
* 批次的剩余本金（`principal_remaining`）会更新为赎回后的剩余金额。
* 批次状态为 `closed` 时，表示该批次已全部赎回并停止计算。

---

### 7.3 产品收益计算与指标定义

#### 1) TWR 计算

* **时间加权收益率（TWR）**：

  * TWR 使用以下公式计算：

    [ r_t = \frac{V_t - CF_t}{V_{t-1}} - 1 ]

    其中：

    * ( V_t ) 为当期产品或批次市值（根据 `product_market_value_series` 聚合计算）
    * ( CF_t ) 为当期外部现金流（来自 `Transaction` 表）
    * ( V_{t-1} ) 为上一期产品市值
  * **注意**：

    * TWR 计算中，**外部现金流不算作收益**，而是用来调整市值的基础。
    * 如果区间内存在买入或卖出行为，TWR 会自动剥离该期间的外部现金流。
    * 若某个期间没有外部现金流，则直接使用市值变化。

#### 2) XIRR 计算

* **内部收益率（XIRR）**：

  * XIRR 计算资金加权收益率，考虑每次买入或卖出的时间和金额。
  * 计算公式：
    [ XIRR = \text{IRR}(CF_t, V_{end}) ]
    其中：

    * ( CF_t ) 是各期间的现金流（买入/卖出），可以通过 `Transaction` 表进行记录
    * ( V_{end} ) 是产品结束时点的市值
  * **注意**：

    * 资金流动（如买入、赎回等）必须通过 `Transaction` 表进行记录。
    * 只有在交易流水完整时，XIRR 才能计算。

---

### 7.4 产品与批次数据流转（工作流）

#### 1) 买入/卖出工作流

* **买入**：每次买入都会创建新的 `Lot`，并记录批次的初始本金和状态。
* **卖出**：每次卖出都会更新批次状态为 `closed`，并记录赎回金额。

  * 部分赎回：`RedemptionAllocation` 记录赎回金额和对应批次。

#### 2) 估值录入工作流

* **按产品估值录入**：允许手动录入 `product_valuations`（`source = manual`），当没有手动值时，自动使用批次估值进行聚合。
* **按批次估值录入**：手动录入每个 `lot_valuations`。

#### 3) 产品市值计算工作流

* 使用 `get_product_market_value_series` 聚合批次估值，生成产品市值序列（`market_value`）。

#### 4) 收益计算工作流

* 根据产品市值序列和现金流（`Transaction`），计算 TWR 和 XIRR。



## 附录：需求澄清
- 资产快照（Snapshot）是权威，因为资产快照不会录错，有些银行理财APP不提供每日的收益。但如果程序中发现某天 Snapshot 的余额 ≠ 由 Transaction 推导出的余额，应该给出warning。 
- 定期/非净值型产品的「收益确认时点」每日隐含计入估值（我会定期更新，但不会每日，需要插值），银行APP也会给出当前的价值，否则长期理财产品很难去比较。 
- 风险等级 R1–R5 是「外部标签」，购买理财产品时，销售方会告知。 
- 赎回日不计入投资市值，从产品持仓中扣除，到账前几天不算可用现金，分holding、redeeming、settled三种状态很合适。 
- 赎回按照指定批次 - 信用卡当前负资产即可，我现金流很好，按时还卡无手续费。 
- 允许“起始估值点”不完整，指标只在数据足够时展示（如 ≥2 周），对缺失数据给“不可比/灰显”而不是硬算