# Sprint 4：赎回在途 & 现金可用性（v3 对齐版）

> 需求基线：`需求文档 v3· 参考收益版`  
> 前置 Sprint：Sprint 3（产品详情页 · 走势可信 · 参考收益）  
> 设计原则：**现金语义优先 · 不误导 · 不做过度精细化**

---

## 一、Sprint 4 的角色定位

### 🎯 Sprint Goal（冻结）
> **清楚区分“钱什么时候不在产品里了”和“钱什么时候真的能用”**，  
> 在不引入 Lot / 批次模型的前提下，正确表达：
> - 赎回在途资金
> - 立即可用现金
> - 未来可用现金的时间点

本 Sprint 不追求精确收益拆分，只追求**现金语义正确**。

---

## 二、Sprint 4 的明确边界（防止过度设计）

### 本 Sprint **不做**
- Lot / InternalHolding（不生成、不分配、不建表）
- 精确的“剩余本金结构”计算
- 赎回收益拆分（本金 vs 收益）
- 现金流预测模型（仅做规则性汇总）

### 本 Sprint **必须做到**
- 赎回 ≠ 到账（语义与数据分离）
- 在途资金不计入“可用现金”
- 用户能回答：**“我现在到底有多少钱能用？”**

---

## 三、核心概念与口径（冻结）

### 3.1 三种现金状态（必须统一）

| 状态 | 含义 | 是否计入可用现金 |
|---|---|---|
| 产品中资金 | 已投入、未赎回 | ❌ |
| 赎回在途 | 已发起赎回、未到账 | ❌ |
| 账户余额 | 已到账 | ✅ |

> 赎回在途资金：**已经不再参与产品走势，但也还不能用**。

---

### 3.2 赎回相关交易类型（延续 Sprint 3）

- `redeem_request`
  - 语义：我向产品发起了赎回
  - 影响：
    - 产品中资金减少（语义层）
    - 生成“赎回在途”记录

- `redeem_settle`
  - 语义：赎回资金到账
  - 影响：
    - 账户余额增加
    - 在途状态结束

> Sprint 4 **不关心**这笔赎回来自哪一笔买入。

---

## 四、功能拆解（按实现顺序）

## S4-1 在途资金建模（轻量，不引入 Lot）【必做】

### 能力说明
- 基于 `redeem_request` 与 `redeem_settle` 的时间差
- 识别“赎回在途金额”

### 规则（冻结）
- 在途金额 =  
  `Σ redeem_request.amount - Σ redeem_settle.amount`（按产品/全局）
- 不做逐笔匹配，只做金额级别追踪

### 验收
- 任意时刻都能算出：
  - 某产品的在途金额
  - 全局在途金额

---

## S4-2 可用现金计算【必做】

### 定义
**可用现金 = Σ 账户余额（is_liquid = true） - 近期确定负债**

### 规则（冻结）
- 不包含：
  - 赎回在途资金
  - 尚未到账的收入
- Snapshot 仍是账户余额的权威来源

### 验收
- Dashboard 上的“可用现金”与用户直觉一致
- 不因赎回操作瞬间跳增

---

## S4-3 未来可用现金（规则性汇总）【必做】

### 能力说明
- 基于已知规则，回答“钱什么时候可能到账”

### 来源
1. 已发起赎回（redeem_request）
   - 根据产品 T+N 规则推算到账日
2. 明确到期产品（如定期理财）

### 展示形式
- 时间轴 / 列表：
  - 日期
  - 预计到账金额
  - 来源说明（赎回 / 到期）

### 验收
- 不承诺精确预测
- 明确标注“预计 / 规则推算”

---

## 五、页面与交互调整

### 5.1 Dashboard（增强）
新增区块：
- 赎回在途金额
- 未来 7 / 30 天预计可用现金

### 5.2 产品详情页（补充）
在产品页补充只读信息：
- 当前在途赎回金额
- 最近一次赎回预计到账日

> 不新增任何复杂操作入口。

---

## 六、常见边界场景（验收用例）

1. **刚发起赎回**
   - 产品市值走势不再包含该金额（语义层）
   - 可用现金不增加
   - 在途金额增加

2. **赎回到账当天**
   - 在途金额减少
   - 账户余额增加
   - 可用现金随之增加

3. **多笔赎回并行**
   - 在途金额可正确累计
   - 不要求逐笔精确匹配

---

## 七、Sprint 4 完成定义（DoD）

当我可以：
- 清楚知道“现在能用多少钱”
- 清楚知道“哪笔钱还在路上”
- 不需要理解任何批次 / 成本结构

则认为 Sprint 4 成功。

---

## 八、与后续 Sprint 的关系

- Sprint 5：资金预测（更长期、更综合）
- Sprint 6：导入与对账
- Sprint 7+：如确有需要，再引入 Lot / 精细收益拆分
